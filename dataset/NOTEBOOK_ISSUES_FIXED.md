# prepare_dataset.ipynb 问题修复说明

## 已修复的问题

### 1. ✅ Omnizart API 错误（已修复）
**问题**: 
- 代码使用了不存在的 `chord_app.get_prediction()` 方法
- Notebook 使用 `v2m_clean` kernel，但 omnizart 需要 `omni` 环境

**修复**: 
- 改为使用正确的 `chord_app.transcribe()` API，并从生成的 CSV 文件中读取和弦信息
- **使用 subprocess 调用 omni 环境的 Python**：在 `v2m_clean` kernel 中通过 subprocess 调用 `/home/jim/anaconda3/envs/omni/bin/python` 来运行 omnizart

**位置**: 单元格 21 (6.2c 使用 Omnizart 自动和弦识别)

**修复内容**:
- 使用 `transcribe()` 替代 `get_prediction()`
- 从生成的 CSV 文件 (`{VIDEO_ID}_chord.csv`) 读取和弦信息
- 添加了 LD_PRELOAD 环境变量设置以解决 libffi 问题
- **创建临时 Python 脚本，通过 subprocess 在 omni 环境中执行**，解决了跨环境调用问题

### 2. ⚠️ 需要注意的问题

#### 2.1 LD_PRELOAD 环境变量设置
**问题**: 多个单元格中重复设置 LD_PRELOAD，但有些单元格可能没有设置
**建议**: 
- 在 notebook 开头统一设置环境变量
- 或者在每个需要 omnizart/pretty_midi 的单元格中都设置

**影响单元格**: 
- 单元格 21 (Omnizart 和弦识别) - 已修复
- 单元格 24-25 (MIDI 生成和 Note Density) - 已有设置但可能不够统一

#### 2.2 文件路径依赖
**问题**: 某些步骤依赖于前面的步骤，但缺少明确的依赖检查
**建议**: 
- 在关键步骤添加文件存在性检查
- 例如：使用 Omnizart 前检查 WAV_PATH 是否存在

#### 2.3 和弦格式兼容性
**问题**: Omnizart 输出的和弦格式可能与项目期望的格式不完全一致
**建议**: 
- 检查 Omnizart 输出的和弦标签格式
- 确保与 `vevo_meta/chord.json` 中的词典兼容
- 可能需要添加格式转换函数

#### 2.4 ✅ 运动特征提取的问题（已修复）
**问题**: 单元格 5 中的运动特征提取逻辑有问题
**位置**: 单元格 5 (运动特征)

**问题描述**:
- `prev_time` 被设置为 `int(curr_time)`，导致时间不连续
- 使用 `CAP_PROP_POS_MSEC` 可能不准确
- 可能遗漏某些秒的数据

**修复内容**:
- 使用帧计数和 FPS 计算时间，更准确
- 修复 `prev_time` 更新逻辑
- 添加缺失秒的填充逻辑
- 确保输出按秒索引排序

#### 2.5 分镜检测的边界问题
**问题**: 单元格 4 中分镜检测的边界处理可能不完整
**位置**: 单元格 4 (分镜 + Scene Offset)

**潜在问题**: 
- `scenedict` 可能不包含所有秒数（如果视频长度不是整数秒）
- 可能导致后续处理时索引错误

**建议**: 确保 `scenedict` 覆盖所有秒数，包括最后一秒

#### 2.6 元数据构建的依赖
**问题**: 单元格 29 (6.5.1) 构建本地字典时，需要先有和弦标注文件
**建议**: 
- 添加检查：如果没有 `.lab` 文件，给出明确提示
- 或者提供默认的空字典

## 使用建议

1. **按顺序执行**: 严格按照单元格顺序执行，不要跳过步骤
2. **检查依赖**: 每个步骤执行后，检查生成的文件是否存在
3. **环境设置**: 确保在正确的 conda 环境中运行（可能需要 v2m_train 或 omni 环境）
4. **Omnizart 使用**: 
   - 使用 omni 环境运行 Omnizart 相关单元格
   - 确保设置了 LD_PRELOAD 环境变量
   - 检查 checkpoints 是否已正确安装

## 测试建议

1. 使用一个简短的测试视频（如 10-30 秒）先测试整个流程
2. 检查每个步骤的输出文件格式是否正确
3. 验证生成的数据集能否被 `vevo_dataset.py` 正确加载

## 待完善的功能

1. **错误处理**: 添加更多的错误处理和用户友好的错误信息
2. **进度显示**: 对于耗时操作（如 CLIP 特征提取），添加进度条
3. **参数化**: 将一些硬编码的参数（如采样率、帧率）提取为配置变量
4. **验证脚本**: 创建一个验证脚本，检查生成的数据集是否完整和格式正确

